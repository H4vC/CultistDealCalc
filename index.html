<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escape from Tarkov Market Analysis</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --background-light: #f8f9fa;
            --surface-light: #ffffff;
            --header-light: #f1f3f5;
            --border-light: #e9ecef;
            --text-primary-light: #212529;
            --text-secondary-light: #495057;
            --hover-light: #e9ecef;
            --shadow-light: 0 2px 8px rgba(0, 0, 0, 0.1);
            --background-dark: #1a1b1e;
            --surface-dark: #25262b;
            --header-dark: #2c2d32;
            --border-dark: #373a40;
            --text-primary-dark: #e9ecef;
            --text-secondary-dark: #adb5bd;
            --hover-dark: #32333a;
            --shadow-dark: 0 2px 8px rgba(0, 0, 0, 0.3);
            --primary-color: #3b82f6;
            --primary-hover: #2563eb;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
        }
        html.dark {
            --background: var(--background-dark);
            --surface: var(--surface-dark);
            --header: var(--header-dark);
            --border: var(--border-dark);
            --text-primary: var(--text-primary-dark);
            --text-secondary: var(--text-secondary-dark);
            --hover: var(--hover-dark);
            --shadow: var(--shadow-dark);
        }
        html.light {
            --background: var(--background-light);
            --surface: var(--surface-light);
            --header: var(--header-light);
            --border: var(--border-light);
            --text-primary: var(--text-primary-light);
            --text-secondary: var(--text-secondary-light);
            --hover: var(--hover-light);
            --shadow: var(--shadow-light);
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s, box-shadow 0.3s;
        }
        body {
            font-family: 'Inter', sans-serif;
            color: var(--text-primary);
            background-color: var(--background);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        header {
            background-color: var(--surface);
            padding: 2rem 1.5rem;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }
        .header-content {
            position: relative;
            z-index: 1;
            max-width: 1200px;
            margin: 0 auto;
        }
        header::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 20% 50%, var(--primary-color) 0%, transparent 50%),
                radial-gradient(circle at 80% 50%, var(--warning-color) 0%, transparent 50%);
            opacity: 0.05;
        }
        h1 {
            text-align: center;
            color: var(--text-primary);
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
        }
        .subtitle {
            text-align: center;
            color: var(--text-secondary);
            font-size: 1.1rem;
            margin-bottom: 2rem;
        }
        main {
            flex-grow: 1;
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            width: 100%;
        }
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            gap: 1.5rem;
            flex-wrap: wrap;
        }
        .control-group {
             display: flex;
             gap: 1rem;
             align-items: center;
        }
        .search-refresh-group {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-grow: 2;
             min-width: 250px;
        }
        .switch-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem 0.8rem;
            border-radius: 8px;
            background-color: var(--surface);
            box-shadow: var(--shadow);
             border: 1px solid var(--border);
        }
        .switch-label {
             color: var(--text-secondary);
             font-size: 0.9rem;
             font-weight: 500;
             margin-right: 0.3rem;
        }
        .switch-value {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 0.9rem;
            min-width: 80px;
            text-align: right;
        }
        .switch {
            position: relative;
            width: 44px;
            height: 24px;
            flex-shrink: 0;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .switch-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border);
            transition: .3s;
            border-radius: 24px;
        }
        .switch-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        input:checked+.switch-slider {
            background-color: var(--primary-color);
        }
        input:checked+.switch-slider:before {
            transform: translateX(20px);
        }
        .search-container {
            flex-grow: 1;
            position: relative;
        }
        .search-input {
            width: 100%;
            padding: 0.75rem 1rem;
            padding-left: 2.5rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            background-color: var(--surface);
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
             box-shadow: var(--shadow);
        }
        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }
        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            pointer-events: none;
        }
        .refresh-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.7rem 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            background-color: var(--surface);
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: var(--shadow);
            white-space: nowrap;
        }
        .refresh-button svg {
             color: var(--text-secondary);
              transition: color 0.2s ease;
        }
        .refresh-button:hover {
            background-color: var(--hover);
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
         .refresh-button:hover svg {
              color: var(--primary-color);
         }
        .refresh-button:active {
             background-color: var(--border);
              box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
        }
        .refresh-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background-color: var(--border);
             box-shadow: none;
        }
         .refresh-button:disabled:hover {
              background-color: var(--border);
              border-color: var(--border);
              color: var(--text-secondary);
         }
          .refresh-button:disabled:hover svg {
               color: var(--text-secondary);
          }
        .results-container {
            background-color: var(--surface);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th,
        td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        th {
            background-color: var(--header);
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
            position: relative;
            padding-right: 2.5rem;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
        }
        th::after {
            content: " ";
             font-family: sans-serif;
            position: absolute;
            right: 1rem;
            color: var(--text-secondary);
            opacity: 0.4;
            font-size: 1.2rem;
             line-height: 1;
            transition: all 0.2s ease;
        }
        th.sorted-asc::after {
            content: "▲";
            opacity: 1;
            color: var(--primary-color);
        }
        th.sorted-desc::after {
            content: "▼";
            opacity: 1;
            color: var(--primary-color);
        }
        th:not(.sorted-asc):not(.sorted-desc):hover::after {
             content: "▲▼";
             opacity: 0.7;
             font-size: 0.8rem;
             letter-spacing: -2px;
             line-height: 1.4;
        }
        th:hover {
            background-color: var(--hover);
             color: var(--text-primary);
        }
        td {
            font-size: 0.95rem;
            transition: background-color 0.2s ease;
            color: var(--text-primary);
        }
        tr:last-child td {
             border-bottom: none;
        }
        tr:hover td {
            background-color: var(--hover);
        }
        td:nth-child(2),
        td:nth-child(3),
        td:nth-child(5) {
            font-family: 'JetBrains Mono', monospace;
            text-align: right;
        }
        td:nth-child(4) {
            text-align: center;
        }
        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
            font-size: 1.1rem;
        }
        .loading::after {
            content: "";
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-left: 10px;
            border: 3px solid var(--border);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            vertical-align: middle;
        }
         @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .theme-toggle {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 100;
            padding: 0.5rem;
            border-radius: 8px;
            background-color: var(--surface);
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
             color: var(--text-secondary);
             font-size: 0.9rem;
        }
        .theme-toggle:hover {
            background-color: var(--hover);
             color: var(--text-primary);
        }
        #theme-icon {
             font-size: 1.1rem;
             line-height: 1;
        }
        @media (max-width: 900px) {
              .controls {
                   flex-direction: column;
                   align-items: stretch;
                   gap: 1rem;
              }
              .control-group {
                   justify-content: center;
              }
              .search-refresh-group {
                    width: 100%;
                    justify-content: center;
              }
              .search-container {
                   max-width: 400px;
              }
         }
        @media (max-width: 768px) {
            h1 { font-size: 2rem; }
            .subtitle { font-size: 1rem; }
             header { padding: 1.5rem 1rem; }
             main { padding: 1.5rem 1rem; }
             .search-refresh-group {
                   flex-wrap: wrap;
                   justify-content: center;
                   gap: 1rem;
             }
             .search-container {
                 width: 100%;
                 max-width: none;
             }
             .refresh-button {
                  flex-grow: 1;
                  justify-content: center;
                   max-width: 200px;
             }
            table {
                display: block;
                overflow-x: auto;
                 white-space: nowrap;
            }
             th, td {
                 padding: 0.8rem 0.75rem;
                 white-space: nowrap;
            }
             th { font-size: 0.8rem; }
             td { font-size: 0.9rem; }
             th:nth-child(1), td:nth-child(1) { min-width: 150px; }
             th:nth-child(2), td:nth-child(2) { min-width: 100px; }
             th:nth-child(3), td:nth-child(3) { min-width: 100px; }
             th:nth-child(4), td:nth-child(4) { min-width: 60px;  }
             th:nth-child(5), td:nth-child(5) { min-width: 100px; }
        }
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--surface);
             border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 5px;
             border: 2px solid var(--surface);
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }
    </style>
</head>
<body>
    <div class="theme-toggle" onclick="toggleTheme()" title="Toggle Theme">
        <span id="theme-icon">🌙</span>
        <span id="theme-text" class="theme-text-label">Dark Mode</span>
    </div>

    <header>
        <div class="header-content">
            <h1>Tarkov Cultist Analysis</h1>
            <p class="subtitle">Track profitable Cultist Deals</p>
        </div>
    </header>

    <main>
        <div class="controls">
            <div class="control-group">
                <div class="switch-container">
                    <span class="switch-label">Base Price:</span>
                    <label class="switch" title="Toggle price range filter">
                        <input type="checkbox" id="priceFilterToggle">
                        <span class="switch-slider"></span>
                    </label>
                    <span class="switch-value" id="priceRangeText">350k-400k</span>
                </div>
            </div>
            <div class="search-refresh-group">
                <div class="search-container">
                    <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="18" height="18">
                       <path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd" />
                   </svg>
                   <input type="text" class="search-input" id="searchInput" placeholder="Search items by name...">
                </div>
                <button id="refreshButton" class="refresh-button" title="Force refresh data from API">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="18" height="18">
                        <path fill-rule="evenodd" d="M15.312 11.424a5.5 5.5 0 01-9.204 2.101l-.724.724a.75.75 0 11-1.06-1.06l.984-.984a.75.75 0 011.203.26l.06.118A7 7 0 0016.75 10h-1.438Zm-1.816-4.525a.75.75 0 01-1.06 1.06l-.984.984a.75.75 0 01-1.203-.26l-.06-.118a7.001 7.001 0 00-11.09 3.791 7 7 0 0012.317 3.91l.724-.724a.75.75 0 111.06 1.06l-.984.984a.75.75 0 01-1.203-.26l-.06-.118a8.5 8.5 0 01-14.874-4.795 8.5 8.5 0 0114.638-5.41l-.724.724a.75.75 0 11-1.06-1.06l.984-.984a.75.75 0 011.203.26l.06.118a7.001 7.001 0 001.776 3.791H16.75a.75.75 0 010 1.5h-3.254Z" clip-rule="evenodd" />
                    </svg>
                    <span>Refresh</span>
                </button>
            </div>
        </div>

        <div class="results-container">
            <div id="results" class="loading">Loading market data</div>
        </div>
    </main>

    <script>
        function toggleTheme() {
            const html = document.documentElement;
            const themeIcon = document.getElementById('theme-icon');
            const themeText = document.getElementById('theme-text');
            const isDark = html.classList.toggle('dark');
            html.classList.toggle('light', !isDark);

            if (isDark) {
                themeIcon.textContent = '🌙';
                themeText.textContent = 'Dark Mode';
                localStorage.setItem('theme', 'dark');
            } else {
                themeIcon.textContent = '☀️';
                themeText.textContent = 'Light Mode';
                localStorage.setItem('theme', 'light');
            }
        }

        function applySavedTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            const html = document.documentElement;
            const themeIcon = document.getElementById('theme-icon');
            const themeText = document.getElementById('theme-text');

            html.className = savedTheme;
            if (savedTheme === 'dark') {
                themeIcon.textContent = '🌙';
                themeText.textContent = 'Dark Mode';
            } else {
                themeIcon.textContent = '☀️';
                themeText.textContent = 'Light Mode';
            }
        }


        const API_ENDPOINT = 'https://api.tarkov.dev/graphql';
        const API_QUERY = `{
            items(lang: en) {
                name
                types
                basePrice
                avg24hPrice
                lastOfferCount
            }
        }`;
        const CACHE_DURATION_MS = 5 * 60 * 1000;
        const CACHE_KEY_DATA = 'tarkovMarketData';
        const CACHE_KEY_TIMESTAMP = 'tarkovMarketTimestamp';

        let minPrice = 350001;
        let maxPrice = 400000;
        let currentData = [];
        let allFetchedData = [];
        let searchTerm = '';
        let currentSortKey = "avg24hPrice";
        let sortDirection = 1;
        let isLoading = false;
        let searchTimeout;
        let refreshIntervalId = null;

        const refreshButton = document.getElementById('refreshButton');
        const resultsElement = document.getElementById('results');


        const filterAndSortData = () => {
            const sourceData = Array.isArray(allFetchedData) ? allFetchedData : [];
            const filtered = sourceData.filter(item =>
                item &&
                item.avg24hPrice !== null &&
                item.basePrice > minPrice / 5 &&
                (maxPrice === null || item.basePrice <= maxPrice) &&
                item.lastOfferCount >= 5 &&
                Array.isArray(item.types) && !item.types.includes('preset') &&
                item.name && !item.name.toLowerCase().includes('poster') &&
                item.basePrice > item.avg24hPrice &&
                item.name.toLowerCase().includes(searchTerm.toLowerCase())
            );
            const sorted = [...filtered].sort((a, b) => {
                const aValue = currentSortKey === "delta" ? (a.basePrice - a.avg24hPrice) : a[currentSortKey];
                const bValue = currentSortKey === "delta" ? (b.basePrice - b.avg24hPrice) : b[currentSortKey];
                if (aValue === null || aValue === undefined) return sortDirection;
                if (bValue === null || bValue === undefined) return -sortDirection;
                if (typeof aValue === 'string') {
                    return aValue.localeCompare(bValue) * sortDirection;
                } else {
                    return (Number(aValue) - Number(bValue)) * sortDirection;
                }
            });
            return sorted;
        };

        const formatPrice = (price) => {
            if (price === null || price === undefined || isNaN(price)) return 'N/A';
            const numPrice = Number(price);
            if (numPrice >= 1000000) {
                return (Math.round(numPrice / 10000) / 100) + 'M ₽';
            } else if (numPrice >= 1000) {
                return Math.round(numPrice / 1000) + 'k ₽';
            }
            return Math.round(numPrice) + ' ₽';
        };

        const displayResults = (data) => {
            resultsElement.classList.remove('loading');
            resultsElement.innerHTML = '';

            if (!Array.isArray(data) || data.length === 0) {
                 const message = searchTerm
                    ? `No items found matching "${searchTerm}" and the current filters.`
                    : 'No items found matching the current filters.';
                resultsElement.innerHTML = `<p style="padding: 2rem; text-align: center; color: var(--text-secondary);">${message}</p>`;
                currentData = [];
                return;
            }

            currentData = data;

            const table = document.createElement('table');
            const thead = table.createTHead();
            const tbody = table.createTBody();
            const headerRow = thead.insertRow();
            const headers = [
                { text: "Name", key: "name" },
                { text: "Flea Price", key: "avg24hPrice" },
                { text: "Base Price", key: "basePrice" },
                { text: "Offers", key: "lastOfferCount" },
                { text: "Base Delta", key: "delta" }
            ];

            headers.forEach(({ text, key }) => {
                const th = document.createElement('th');
                th.textContent = text;
                th.dataset.key = key;
                th.addEventListener('click', () => handleSort(key));
                if (key === currentSortKey) {
                    th.classList.add(sortDirection === 1 ? 'sorted-asc' : 'sorted-desc');
                } else {
                    th.classList.remove('sorted-asc', 'sorted-desc');
                }
                headerRow.appendChild(th);
            });

            data.forEach(item => {
                if (!item) return;
                const row = tbody.insertRow();
                row.insertCell().textContent = item.name || 'Unknown Name';
                row.insertCell().textContent = formatPrice(item.avg24hPrice);
                row.insertCell().textContent = formatPrice(item.basePrice);
                row.insertCell().textContent = item.lastOfferCount !== null && item.lastOfferCount !== undefined ? item.lastOfferCount : 'N/A';
                 const delta = (item.basePrice !== null && item.avg24hPrice !== null)
                    ? item.basePrice - item.avg24hPrice
                    : null;
                row.insertCell().textContent = formatPrice(delta);
            });

            resultsElement.appendChild(table);
        };

        const handleSort = (key) => {
            if (isLoading) return;
            if (currentSortKey === key) {
                sortDirection *= -1;
            } else {
                currentSortKey = key;
                sortDirection = 1;
            }
            const processedData = filterAndSortData();
            displayResults(processedData);
        };

        const updatePriceRangeText = () => {
            const isChecked = document.getElementById('priceFilterToggle').checked;
            const text = isChecked ? '400k+' : '350k-400k';
            document.getElementById('priceRangeText').textContent = text;
        };

        const handleFilterChange = () => {
            if (isLoading) return;
            const isChecked = document.getElementById('priceFilterToggle').checked;
            minPrice = isChecked ? 400001 : 350001;
            maxPrice = isChecked ? null : 400000;
            updatePriceRangeText();
            const processedData = filterAndSortData();
            displayResults(processedData);
        };

        const handleSearch = (event) => {
             if (isLoading) return;
            searchTerm = event.target.value;
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const processedData = filterAndSortData();
                displayResults(processedData);
            }, 300);
        };

        const fetchData = (isAutoRefresh = false, force = false) => {
            if (isLoading) {
                 console.log("Fetch skipped: already loading.");
                 return;
            }
            isLoading = true;
            if(refreshButton) refreshButton.disabled = true;

            const cachedTimestamp = localStorage.getItem(CACHE_KEY_TIMESTAMP);
            const cachedDataJSON = localStorage.getItem(CACHE_KEY_DATA);
            const now = Date.now();
            let isCacheValid = false;
            let parsedCacheData = null;

            if (!force && cachedTimestamp && cachedDataJSON) {
                const timestamp = parseInt(cachedTimestamp, 10);
                if (!isNaN(timestamp) && (now - timestamp < CACHE_DURATION_MS)) {
                    try {
                        parsedCacheData = JSON.parse(cachedDataJSON);
                        if (Array.isArray(parsedCacheData)) {
                            isCacheValid = true;
                        } else {
                            console.warn("Cached data is not an array. Ignoring cache.");
                            parsedCacheData = null;
                        }
                    } catch (e) {
                        console.error("Error parsing cached data:", e);
                        localStorage.removeItem(CACHE_KEY_DATA);
                        localStorage.removeItem(CACHE_KEY_TIMESTAMP);
                    }
                } else {
                     if (!isAutoRefresh) console.log("Cache expired.");
                }
            } else if (force) {
                 console.log("Force refresh requested, ignoring cache.");
            }
             else {
                 if (!isAutoRefresh) console.log("No cache found.");
            }

            if (isCacheValid && !force) {
                 if (!isAutoRefresh) console.log("Using cached data.");
                 allFetchedData = parsedCacheData;
                 const processedData = filterAndSortData();
                 displayResults(processedData);
                 isLoading = false;
                 if(refreshButton) refreshButton.disabled = false;
            } else {
                 if (force || !isAutoRefresh) {
                     console.log(`Workspaceing new data from API... (Force: ${force}, AutoRefresh: ${isAutoRefresh})`);
                     resultsElement.classList.add('loading');
                     resultsElement.innerHTML = '<p>Loading market data</p>';
                     const headers = document.querySelectorAll('th');
                     headers.forEach(h => h.classList.remove('sorted-asc', 'sorted-desc'));
                 } else {
                     console.log("Auto-refresh: Cache invalid or expired, fetching in background...");
                 }

                fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify({ query: API_QUERY }),
                })
                    .then(response => {
                        if (!response.ok) {
                            return response.text().then(text => {
                                throw new Error(`HTTP error! status: ${response.status}, message: ${text || 'No details'}`);
                            });
                        }
                        return response.json();
                    })
                    .then(result => {
                        if (result.errors) {
                            throw new Error(result.errors.map(e => e.message).join(', '));
                        }
                        const items = result.data?.items;
                        if (!Array.isArray(items)) {
                            throw new Error("API response did not contain an items array.");
                        }

                        console.log("Data fetched successfully.");
                        allFetchedData = items;

                        try {
                            localStorage.setItem(CACHE_KEY_DATA, JSON.stringify(allFetchedData));
                            localStorage.setItem(CACHE_KEY_TIMESTAMP, now.toString());
                            console.log("Data cached successfully.");
                        } catch (e) {
                            console.error("Error saving data to localStorage:", e);
                        }

                        const processedData = filterAndSortData();
                        displayResults(processedData);
                    })
                    .catch(error => {
                        console.error('Error during fetch:', error);
                        if (!isAutoRefresh || force) {
                             resultsElement.classList.remove('loading');
                             resultsElement.innerHTML = `
                                <p style="padding: 2rem; text-align: center; color: var(--danger-color);">
                                    Error loading data: ${error.message}. Please try again later.
                                </p>`;
                        } else {
                             console.warn("Auto-refresh failed:", error.message);
                        }
                    })
                    .finally(() => {
                        isLoading = false;
                        if(refreshButton) refreshButton.disabled = false;
                        resultsElement.classList.remove('loading');
                         if (!resultsElement.hasChildNodes() && !isLoading) {
                             displayResults([]);
                         }
                    });
            }
        };

        applySavedTheme();

        document.getElementById('priceFilterToggle').addEventListener('change', handleFilterChange);
        document.getElementById('searchInput').addEventListener('input', handleSearch);
        if (refreshButton) {
            refreshButton.addEventListener('click', () => {
                fetchData(false, true);
            });
        } else {
            console.error("Refresh button element not found!");
        }


        updatePriceRangeText();
        fetchData();

        console.log(`Setting up auto-refresh every ${CACHE_DURATION_MS / 1000 / 60} minutes.`);
        if (refreshIntervalId) {
            clearInterval(refreshIntervalId);
        }
        refreshIntervalId = setInterval(() => {
            fetchData(true, false);
        }, CACHE_DURATION_MS);

    </script>
</body>
</html>